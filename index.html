<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YouTube Playlist OBS Player</title>
    <style>
      html, body { margin: 0; padding: 0; overflow: hidden; background-color: black; }
      #loading {
          position: absolute;
          color: white;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-family: Arial, sans-serif;
          font-size: 20px;
      }
      #message {
          position: absolute;
          color: white;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-family: Arial, sans-serif;
          font-size: 18px;
          text-align: center;
      }
    </style>
</head>
<body>
<div id="player"></div>
<div id="loading">Loading...</div>
<div id="message" style="display:none;">Missing playlist parameter in URL.<br>Please set ?playlist=YOUR_PLAYLIST_ID</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
  // Parse URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const playlistId = urlParams.get('playlist');
  const volumeLevel = parseInt(urlParams.get('volume')) || 50;

  // If playlist parameter missing, show message and do nothing
  if (!playlistId) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('message').style.display = 'block';
  }

  let player, updater;
  const storageKey = playlistId ? `yt-player-${playlistId}` : null;

  function onYouTubeIframeAPIReady() {
    if (!playlistId) return; // no playlist

    // Load saved state from localStorage
    const saved = JSON.parse(localStorage.getItem(storageKey) || 'null') || {index: 0, time: 0};

    player = new YT.Player('player', {
      width: 1920,
      height: 1080,
      playerVars: {
        listType: 'playlist',
        list: playlistId,
        autoplay: 1,
        controls: 0,
        rel: 0
      },
      events: {
        'onReady': function() { onPlayerReady(saved); },
        'onStateChange': onPlayerStateChange
      }
    });
  }

  function onPlayerReady(saved) {
    player.setVolume(volumeLevel);
    // Always start at saved index/time
    if (saved && typeof saved.index === 'number') {
        player.playVideoAt(saved.index);
        setTimeout(function() {
            if (saved.time) player.seekTo(saved.time, true);
            player.playVideo();
            document.getElementById('loading').style.display = 'none';
        }, 1000);
    } else {
        player.playVideo();
        document.getElementById('loading').style.display = 'none';
    }
  }

  function onPlayerStateChange(event) {
    clearInterval(updater);
    // When video playing, periodically save index and time
    if (event.data === YT.PlayerState.PLAYING) {
      updater = setInterval(function() {
        localStorage.setItem(storageKey, JSON.stringify({
          index: player.getPlaylistIndex(),
          time: player.getCurrentTime()
        }));
      }, 1000);
    }

    // When ended, update to next index and reset time
    if (event.data === YT.PlayerState.ENDED) {
      let nextIndex = player.getPlaylistIndex() + 1;
      // Loop if at last video
      if (nextIndex >= player.getPlaylist().length) {
        nextIndex = 0;
      }
      localStorage.setItem(storageKey, JSON.stringify({index: nextIndex, time: 0}));
      player.playVideoAt(nextIndex);
    }
  }

  // On visibility change, pause/resume and save state
  document.addEventListener('visibilitychange', function() {
    if (!playlistId) return;
    if (document.hidden) {
      clearInterval(updater);
      localStorage.setItem(storageKey, JSON.stringify({
        index: player.getPlaylistIndex(),
        time: player.getCurrentTime()
      }));
      player.pauseVideo();
    } else {
      // When back to visible, read saved state and resume
      const saved = JSON.parse(localStorage.getItem(storageKey) || 'null') || {index: 0, time: 0};
      // Load correct video
      player.playVideoAt(saved.index);
      // Wait some time before seeking to ensure video loads
      setTimeout(function() {
        if (saved.time) player.seekTo(saved.time, true);
        player.playVideo();
      }, 1000);
    }
  });
</script>
</body>
</html>
